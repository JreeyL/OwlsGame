<!DOCTYPE html>
<html>
<head>
  <title>Scores Administration</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <style>
    .score-table {
      margin-top: 20px;
    }
    .filter-section {
      margin: 20px 0;
    }
  </style>
</head>
<body>
<div class="w3-container w3-teal">
  <h1>Scores Administration</h1>
  <p class="w3-tiny">Current Date: <span id="current-date"></span></p>
</div>

<div class="w3-container">
  <h2>Score Management</h2>
  <p>This is the admin panel for managing game scores.</p>

  <div class="w3-panel w3-pale-blue">
    <p>View and manage player scores here.</p>
  </div>

  <!-- 过滤选项 -->
  <div class="w3-card w3-padding filter-section">
    <h3>Filter Scores</h3>
    <div class="w3-row-padding">
      <div class="w3-third">
        <label>Game</label>
        <select class="w3-select w3-border" id="game-filter">
          <option value="">All Games</option>
          <!-- Games will be loaded here -->
        </select>
      </div>
      <div class="w3-third">
        <label>User Email</label>
        <input class="w3-input w3-border" type="text" id="user-filter" placeholder="Filter by email">
      </div>
      <div class="w3-third">
        <label>&nbsp;</label>
        <button class="w3-button w3-block w3-teal" onclick="applyFilters()">Apply Filters</button>
      </div>
    </div>
  </div>

  <!-- 分数列表 -->
  <div class="w3-card w3-padding score-table">
    <h3>Score Records</h3>
    <div id="loading" class="w3-center">
      <p><i class="w3-spin w3-xxlarge">↻</i></p>
      <p>Loading scores...</p>
    </div>
    <table class="w3-table-all" id="scores-table" style="display:none;">
      <thead>
      <tr class="w3-teal">
        <th>ID</th>
        <th>User</th>
        <th>Game</th>
        <th>Score</th>
        <th>Play Time</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody id="scores-list">
      <!-- Scores will be loaded here -->
      </tbody>
    </table>
    <div id="no-scores" class="w3-panel w3-pale-red" style="display:none;">
      <h4>No scores found</h4>
      <p>No matching score records in the database.</p>
    </div>
  </div>

  <!-- 统计信息 -->
  <div class="w3-card w3-padding w3-margin-top">
    <h3>Statistics</h3>
    <div class="w3-row-padding">
      <div class="w3-quarter w3-center">
        <div class="w3-card w3-pale-blue w3-padding">
          <h4 id="total-scores">0</h4>
          <p>Total Scores</p>
        </div>
      </div>
      <div class="w3-quarter w3-center">
        <div class="w3-card w3-pale-green w3-padding">
          <h4 id="total-users">0</h4>
          <p>Players</p>
        </div>
      </div>
      <div class="w3-quarter w3-center">
        <div class="w3-card w3-pale-yellow w3-padding">
          <h4 id="avg-score">0</h4>
          <p>Avg. Score</p>
        </div>
      </div>
      <div class="w3-quarter w3-center">
        <div class="w3-card w3-pale-red w3-padding">
          <h4 id="top-score">0</h4>
          <p>Top Score</p>
        </div>
      </div>
    </div>
  </div>

  <div class="w3-margin-top">
    <a href="/game-admin/games" class="w3-button w3-blue">Go to Games Admin</a>
    <a href="/" class="w3-button w3-green">Back to Home</a>
  </div>
</div>

<script>
  // 显示当前日期
  document.getElementById('current-date').textContent = new Date().toISOString().slice(0, 10);

  // 页面加载时执行
  window.onload = function() {
    loadGames();
    loadScores();
  };

  // 加载游戏列表到过滤器
  function loadGames() {
    fetch('/api/admin/games')
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(games => {
              const select = document.getElementById('game-filter');

              // 添加默认选项
              games.forEach(game => {
                const option = document.createElement('option');
                option.value = game.id;
                option.textContent = game.name;
                select.appendChild(option);
              });
            })
            .catch(error => {
              console.error('Error loading games:', error);
              // 添加模拟游戏选项
              const select = document.getElementById('game-filter');
              const option = document.createElement('option');
              option.value = "1";
              option.textContent = "True/False";
              select.appendChild(option);
            });
  }

  // 加载分数记录
  function loadScores(gameId = '', userEmail = '') {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('scores-table').style.display = 'none';
    document.getElementById('no-scores').style.display = 'none';

    let url = '/api/admin/scores';
    const params = [];

    if (gameId) params.push(`gameId=${gameId}`);
    if (userEmail) params.push(`email=${encodeURIComponent(userEmail)}`);

    if (params.length > 0) {
      url += '?' + params.join('&');
    }

    fetch(url)
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              displayScores(data.scores);
              updateStatistics(data.stats);
            })
            .catch(error => {
              console.error('Error loading scores:', error);
              // 如果API不可用，显示模拟数据
              displayMockScores();
            })
            .finally(() => {
              document.getElementById('loading').style.display = 'none';
            });
  }

  // 显示分数数据
  function displayScores(scores) {
    const tableBody = document.getElementById('scores-list');
    tableBody.innerHTML = '';

    if (!scores || scores.length === 0) {
      document.getElementById('no-scores').style.display = 'block';
    } else {
      scores.forEach(score => {
        const row = document.createElement('tr');
        const date = new Date(score.timestamp).toLocaleString();
        row.innerHTML = `
          <td>${score.id}</td>
          <td>${score.email}</td>
          <td>${score.gameName || 'Unknown'}</td>
          <td>${score.scoreValue}</td>
          <td>${score.playTime} sec</td>
          <td>${date}</td>
          <td>
            <button class="w3-button w3-tiny w3-red" onclick="deleteScore(${score.id})">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
      document.getElementById('scores-table').style.display = 'table';
    }
  }

  // 显示模拟分数数据
  function displayMockScores() {
    const mockScores = [
      {
        id: 1,
        email: "jreeylee92@outlook.com",
        gameName: "True/False",
        scoreValue: 2,
        playTime: 60,
        timestamp: "2025-08-25T18:55:37.451689"
      }
    ];

    displayScores(mockScores);

    // 更新统计信息
    updateStatistics({
      totalScores: 1,
      uniqueUsers: 1,
      averageScore: 2,
      highestScore: 2
    });
  }

  // 更新统计信息
  function updateStatistics(stats) {
    document.getElementById('total-scores').textContent = stats.totalScores || 0;
    document.getElementById('total-users').textContent = stats.uniqueUsers || 0;
    document.getElementById('avg-score').textContent = stats.averageScore || 0;
    document.getElementById('top-score').textContent = stats.highestScore || 0;
  }

  // 应用过滤器
  function applyFilters() {
    const gameId = document.getElementById('game-filter').value;
    const userEmail = document.getElementById('user-filter').value;
    loadScores(gameId, userEmail);
  }

  // 删除分数
  function deleteScore(id) {
    if (confirm('Are you sure you want to delete this score record? This action cannot be undone.')) {
      fetch('/api/admin/scores/' + id, {
        method: 'DELETE'
      })
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Failed to delete score');
        }
      })
      .then(data => {
        alert('Score record deleted successfully!');
        // 重新加载分数数据
        loadScores();
      })
      .catch(error => {
        console.error('Error deleting score:', error);
        alert('Failed to delete score record. Please try again.');
      });
    }
  }
</script>
</body>
</html>